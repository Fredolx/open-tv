<ng-keyboard-shortcuts [shortcuts]="shortcuts"></ng-keyboard-shortcuts>
<ng-keyboard-shortcuts-help [key]="'f1'" [closeKey]="'escape'" [title]="'Help'" />

<div class="app-container">
  <!-- Header Section -->
  <app-home-header
    [selectedCount]="selectedChannels.size"
    [selectionMode]="selectionMode"
    [bulkDisabled]="!!filters?.series_id && !filters?.season"
    [bulkMenu]="bulkMenu"
    (toggleSelectionMode)="toggleSelectionMode()"
    (clearSelection)="clearSelection()"
    (openSettings)="openSettings()"
  ></app-home-header>

  <!-- Sticky Bulk Actions Bar -->
  <app-bulk-action-bar
    [visible]="selectedChannels.size > 0"
    (action)="bulkActionFromBar($event)"
    (cancel)="clearSelection()"
  ></app-bulk-action-bar>

  <!-- Search & Controls Section (Apple Premium Design - Reference Matching) -->
  <section class="controls-section glass-toolbar">
    <div class="toolbar-stack">
      <!-- 1. Search Container (Top) -->
      <div class="search-container">
        <div class="search-box premium-glass-input">
          <input
            autocomplete="off"
            #search
            type="text"
            class="search-input"
            placeholder="Type to search..."
            title="Search"
            [attr.aria-label]="'Search'"
          />
          <div class="search-actions">
            <button class="icon-btn" (click)="reload()" title="Reload">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                  d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"
                />
              </svg>
            </button>
            <app-sort-button></app-sort-button>
          </div>
        </div>
      </div>

      <!-- 2. Primary View Modes Segmented Control -->
      <nav class="view-segmented-control apple-segmented">
        <button
          (click)="switchMode(viewModeEnum.All)"
          class="segment-btn"
          [class.active]="filters?.view_type == viewModeEnum.All"
        >
          All
        </button>
        <button
          (click)="switchMode(viewModeEnum.Categories)"
          class="segment-btn"
          [class.active]="filters?.view_type == viewModeEnum.Categories"
        >
          Categories
        </button>
        <button
          (click)="switchMode(viewModeEnum.Favorites)"
          class="segment-btn"
          [class.active]="filters?.view_type == viewModeEnum.Favorites"
        >
          Favorites
        </button>
        <button
          (click)="switchMode(viewModeEnum.History)"
          class="segment-btn"
          [class.active]="filters?.view_type == viewModeEnum.History"
        >
          History
        </button>
      </nav>

      <!-- 3. Media Type Switches (Pill Style from Reference) -->
      <app-media-filter-pill
        [chkLiveStream]="chkLiveStream"
        [chkMovie]="chkMovie"
        [chkSerie]="chkSerie"
        [showSeries]="anyXtream()"
        (toggle)="updateMediaTypes($event)"
      ></app-media-filter-pill>
    </div>
  </section>

  <!-- Selection Actions Bar -->
  <div *ngIf="selectionMode" class="selection-bar" @fadeInOut>
    <span class="selection-count" *ngIf="selectedChannels.size > 0">
      {{ selectedChannels.size }} selected
    </span>
    <button class="btn-action" (click)="selectAllView()">Select All</button>
    <ng-container *ngIf="selectedChannels.size > 0">
      <button class="btn-action btn-hide" (click)="bulkActionOnSelected(bulkActionType.Hide)">
        Hide
      </button>
      <button class="btn-action btn-show" (click)="bulkActionOnSelected(bulkActionType.Unhide)">
        Unhide
      </button>
      <button class="btn-action btn-fav" (click)="bulkActionOnSelected(bulkActionType.Favorite)">
        Favorite
      </button>
      <button
        class="btn-action btn-whitelist"
        (click)="whitelistSelected()"
        [ngbTooltip]="'Keep only selected visible'"
      >
        Whitelist
      </button>
    </ng-container>
    <button
      class="btn-action btn-clear"
      *ngIf="selectedChannels.size > 0"
      (click)="clearSelection()"
    >
      Clear
    </button>
  </div>

  <app-breadcrumb
    [visible]="
      (!!filters?.view_type == !!viewModeEnum.Categories && !!filters?.group_id) ||
      !!filters?.series_id
    "
    [text]="nodeStack.get()?.toString() || ''"
    (back)="goBack()"
  ></app-breadcrumb>
  <!-- Content Grid -->
  <main class="content-grid">
    <div class="channels-container list-view" [@fade]="channelsVisible ? 'visible' : 'hidden'">
      <app-channel-tile
        [attr.id]="i == 0 ? 'first' : null"
        *ngFor="let channel of channels; let i = index"
        class="channel-item"
        [id]="i"
        [channel]="channel"
        [viewMode]="viewType"
        [threeLines]="false"
        [compact]="true"
        [selectionMode]="selectionMode"
        [selected]="selectedChannels.has(channel.id!)"
        (selectionToggled)="toggleChannelSelection($event)"
        (requestDetails)="openDetails($event)"
      ></app-channel-tile>
    </div>

    <!-- Load More Button -->
    <button
      *ngIf="!reachedMax"
      (click)="loadMore()"
      class="load-more-btn"
      [@fade]="channelsVisible ? 'visible' : 'hidden'"
    >
      <span>Load More</span>
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" />
      </svg>
    </button>
  </main>
</div>

<!-- Scroll to Top Button -->
<div *ngIf="showScrollTop" (click)="scrollToTop()" class="scroll-to-top">
  <svg viewBox="0 0 24 24" fill="currentColor">
    <path d="M7.41,15.41L12,10.83L16.59,15.41L18,14L12,8L6,14L7.41,15.41Z" />
  </svg>
</div>

<!-- Bulk Actions Menu -->
<mat-menu #bulkMenu="matMenu">
  <button mat-menu-item (click)="bulkAction(bulkActionType.Hide)">Hide all</button>
  <button mat-menu-item (click)="bulkAction(bulkActionType.Unhide)">Unhide all</button>
  <button
    mat-menu-item
    (click)="bulkAction(bulkActionType.Favorite)"
    [disabled]="filters?.view_type == viewModeEnum.Categories"
  >
    Favorite all
  </button>
  <button
    mat-menu-item
    (click)="bulkAction(bulkActionType.Unfavorite)"
    [disabled]="filters?.view_type == viewModeEnum.Categories"
  >
    Unfavorite all
  </button>
</mat-menu>

<!-- Content Detail Modal -->
<app-content-detail-modal
  [channel]="selectedChannelForModal"
  [isOpen]="!!selectedChannelForModal"
  [isLoadingDetails]="isLoadingDetails"
  (close)="onModalClose()"
  (play)="onModalPlay()"
></app-content-detail-modal>
